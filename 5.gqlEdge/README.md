# ENTGO GQL_EDGE

## GQL_EDGE

### Add a new schema `Car`
```
go run -mod=mod entgo.io/ent/cmd/ent new Car
```

### Modify our `car.go` schema
```go
package schema

import (
	"time"

	"entgo.io/ent"
	"entgo.io/ent/schema/edge"
	"entgo.io/ent/schema/field"
)

// Car holds the schema definition for the Car entity.
type Car struct {
	ent.Schema
}

// Fields of the Car.
func (Car) Fields() []ent.Field {
	return []ent.Field{
		field.Text("model").NotEmpty(),
		field.Text("plate_number").Unique().NotEmpty(),
		field.Time("created_at").
			Default(time.Now).
			Immutable(),
	}
}

// Edges of the Car.
func (Car) Edges() []ent.Edge {
	return []ent.Edge{
		edge.From("owner", User.Type).
			Ref("cars").
			Unique(),
	}
}

func (Car) Annotations() []schema.Annotation {
	return []schema.Annotation{
		entgql.QueryField(),
		entgql.Mutations(entgql.MutationCreate(), entgql.MutationUpdate()),
	}
}
```

### Also modify our `user.go` schema
```go
//...

// Edges of the User.
func (User) Edges() []ent.Edge {
	return []ent.Edge{
		edge.To("cars", Car.Type),
	}
}
```

### Create new `car.graphql` file with this content
```graphql
type CarMutation {
    # The input and the output are types generated by Ent.
    createCar(input: CreateCarInput!): Car

    updateCar(id: ID!, input: UpdateCarInput!): Car

    deleteCar(id: ID!): Car
}
```

### Create new `extended.graphql` with this content for our edge schema
```graphql
extend input CreateUserInput {
  createCars: [CreateCarInput!]
}
```

### Update out `gqlgen.yml` file to include the new schema
```yml
schema:
  - ent.graphql
  - user.graphql
  - car.graphql
  - extended.graphql

autobind:
  - gqlEdge/ent
  - gqlEdge/ent/user
  - gqlEdge/ent/car
```

### Generate the code
```
go generate .
```

### Modify `car.resolvers.go`
```go
// CreateCar is the resolver for the createCar field.
func (r *carMutationResolver) CreateCar(ctx context.Context, obj *ent.CarMutation, input ent.CreateCarInput) (*ent.Car, error) {
	return r.client.Car.Create().SetInput(input).Save(ctx)
}

// UpdateCar is the resolver for the updateCar field.
func (r *carMutationResolver) UpdateCar(ctx context.Context, obj *ent.CarMutation, id int, input ent.UpdateCarInput) (*ent.Car, error) {
	return nil, r.client.Car.UpdateOneID(id).SetInput(input).Exec(ctx)
}

// DeleteCar is the resolver for the deleteCar field.
func (r *carMutationResolver) DeleteCar(ctx context.Context, obj *ent.CarMutation, id int) (*ent.Car, error) {
	return nil, r.client.Car.DeleteOneID(id).Exec(ctx)
}
```

### Modify `extended.resolvers.go`
```go
// CreateCars is the resolver for the createCars field.
func (r *createUserInputResolver) CreateCars(ctx context.Context, obj *ent.CreateUserInput, data []*ent.CreateCarInput) error {
	// NOTE: We need to use the Ent client from the context.
	// To ensure we create all of the children in the same transaction.
	// See: Transactional Mutations for more information.
	c := ent.FromContext(ctx)
	builders := make([]*ent.CarCreate, len(data))
	for i := range data {
		builders[i] = c.Car.Create().SetInput(*data[i])
	}
	todos, err := c.Car.CreateBulk(builders...).Save(ctx)
	if err != nil {
		return err
	}
	ids := make([]int, len(todos))
	for i := range todos {
		ids[i] = todos[i].ID
	}
	obj.CarIDs = append(obj.CarIDs, ids...)
	return nil
}
```

### Add transactional client to server. Modify `cmd/gqlEdge/main.go`
```go
srv := handler.NewDefaultServer(gqlEdge.NewSchema(client))
srv.Use(entgql.Transactioner{TxOpener: client}) //Add this line
http.Handle("/",
  playground.Handler("User", "/query"),
)
```

### Modify `user.resolvers.go` to use transactional client
```go
// CreateUser is the resolver for the createUser field.
func (r *mutationResolver) CreateUser(ctx context.Context, input ent.CreateUserInput) (*ent.User, error) {
	return ent.FromContext(ctx).User.Create().SetInput(input).Save(ctx)
}

// UpdateUser is the resolver for the updateUser field.
func (r *mutationResolver) UpdateUser(ctx context.Context, id int, input ent.UpdateUserInput) (*ent.User, error) {
	return ent.FromContext(ctx).User.UpdateOneID(id).SetInput(input).Save(ctx)
}
```

### Modify `car.resolvers.go` to use transactional client
```go
// CreateCar is the resolver for the createCar field.
func (r *carMutationResolver) CreateCar(ctx context.Context, obj *ent.CarMutation, input ent.CreateCarInput) (*ent.Car, error) {
	return ent.FromContext(ctx).Car.Create().SetInput(input).Save(ctx)
}

// UpdateCar is the resolver for the updateCar field.
func (r *carMutationResolver) UpdateCar(ctx context.Context, obj *ent.CarMutation, id int, input ent.UpdateCarInput) (*ent.Car, error) {
	return ent.FromContext(ctx).Car.UpdateOneID(id).SetInput(input).Save(ctx)
}
```

## TEST

### Run the server
```
go run ./cmd/gqlEdge
```

### Add a user with some cars
```graphql
mutation createUser {
  createUser(input: {
    name: "yourName", 
    email: "yourEmail@gmail.com"
  	createCars: [
      { model: "Ford", plateNumber: "8888"},
      { model: "Bentley", plateNumber: "0088"}
    ]
  }) {
    id, 
    name,
    email,
    createdAt
  }
}

# Output
# {
#   "data": {
#     "createUser": {
#       "id": "4294967297",
#       "name": "yourName2",
#       "email": "yourEmail@gmail.com",
#       "createdAt": "2023-06-14T08:47:16.5162836+08:00"
#     }
#   }
# }
```

### Query the result
```graphql
query AllUsers {
  users {
    id,
    name,
    email,
    createdAt,
    cars {
      id,
      model
    }
  }
}

# Output
# {
#   "data": {
#     "users": [
#       {
#         "id": "4294967297",
#         "name": "yourName2",
#         "email": "yourEmail@gmail.com",
#         "createdAt": "2023-06-14T08:47:16.5162836+08:00",
#         "cars": [
#           {
#             "id": "1",
#             "model": "Ford"
#           },
#           {
#             "id": "2",
#             "model": "Bentley"
#           }
#         ]
#       }
#     ]
#   }
# }
```